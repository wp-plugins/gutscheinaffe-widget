(function(a,b,c){var d=function(a){this.options=a;this.id=0;this.xhr=null};d.prototype.abort=function(){this.id++;if(this.xhr){this.xhr.abort()}};d.prototype.send=function(a){this.abort();var c=b.extend(true,{},this.options,a);if(c.success){var d=this.id;var e=this;var f=c.success;c.success=function(a,b,c){e.xhr=null;if(d===e.id){f(a,b,c)}}}this.xhr=b.ajax(c)};var e=function(a,b,c){this.input=a;this.list=b.hide();this.onSelect=c;this.cache={};this.selected=null;this.xhr=new d({url:"http://www.gutscheinaffe.de/api/v1/",dataType:"jsonp",data:{method:"getShops",query:""}});this.delay=300;this.minlength=2;this.bindEvents()};e.prototype.afterTyping=function(){if(this.input.val().length>=this.minlength){this.getList(this.input.val())}};e.prototype.bindEvents=function(){var a=this;this.input.on("keyup",function(b){a.onKeyup(b)});this.input.on("blur",function(b){a.list.fadeOut(a.delay)});this.input.closest("form").on("submit",function(){return false})};e.prototype.onKeyup=function(b){switch(b.keyCode){case 38:if(this.selected&&this.selected.length>0){this.selected.removeClass("selected");this.selected=this.selected.prev()}else{this.selected=this.list.find("li:last-child")}this.selected.addClass("selected");break;case 40:if(this.selected&&this.selected.length>0){this.selected.removeClass("selected");this.selected=this.selected.next()}else{this.selected=this.list.find("li:first-child")}this.selected.addClass("selected");break;case 13:if(this.selected&&this.selected.length>0){this.selected.trigger("click")}break;default:a.clearTimeout(this.timeout);var c=this;this.timeout=a.setTimeout(function(){c.afterTyping()},this.delay);break}};e.prototype.getList=function(a){var c=a.substr(0,this.minlength);if(this.cache[c]){this.showList(b.grep(this.cache[c],function(b){return b.name.toLowerCase().indexOf(a.toLowerCase())>=0}))}else{var d=this;this.xhr.send({data:{query:c},success:function(e,f,g){if(e&&e.success===true){d.cache[c]=e.result;d.showList(b.grep(e.result,function(b){return b.name.toLowerCase().indexOf(a.toLowerCase())>=0}))}},cache:true})}};e.prototype.showList=function(a){var c=this;this.list.hide().empty();for(var d=0;d<a.length;d++){b('<li><a href="javascript:void(false);">'+a[d].name+" ("+a[d].count+")</a></li>").on("click",{shop:a[d]},function(a){var b=c.onSelect(a);c.input.val(a.data.shop.name).trigger("blur");return b}).appendTo(this.list)}this.list.show()};var f=function(a){var c=this;this.context=a;this.categories=b(".gutscheinaffe_widget-select",a);this.table=b(".gutscheinaffe_widget-table",a);this.input=b(".gutscheinaffe_widget-query",a);this.tablecon=b(".gutscheinaffe_widget-table-container",a);this.cache={shop:{},category:{},other:{}};this.config={};b(".gutscheinaffe_widget-config",a).each(function(a,d){d=b(d);c.config[d.attr("name")]=d.val()});this.autocomplete=new e(this.input,b(".gutscheinaffe_widget-autocomplete",a),function(a){return c.onSelect(a)});this.xhr=new d({url:"http://www.gutscheinaffe.de/api/v1/",dataType:"jsonp",success:function(a,b,d){if(a&&a.success===true){c.showCoupons(a.result)}},data:{limit:this.config.limit},cache:true,beforeSend:function(){c.table.empty();c.tablecon.addClass("loading")},complete:function(){c.tablecon.removeClass("loading")}});this.setupCategories();this.performDefault()};f.prototype.showCoupons=function(a){this.table.empty();var b="";for(var c=0;c<a.length;c++){var d=a[c];var e=this.buildHref(d.url);b+="<tr>"+'<td class="gutscheinaffe_widget-logo"> <a target="_blank" rel="nofollow" href="'+e+'" title="'+d.title+'"><img width="88" height="33" src="'+d.logo+'" /></a></td>'+'<td class="gutscheinaffe_widget-worth"><a target="_blank" rel="nofollow" href="'+e+'" title="'+d.title+'">'+(d.worth||"Gutschein")+"</a></td>"+'<td class="gutscheinaffe_widget-link"> <a target="_blank" rel="nofollow" href="'+e+'" title="'+d.title+'">Â»</a></td>'+"</tr>"}this.table.html(b)};f.prototype.setupCategories=function(){var a=this;this.categories.on("change",function(c){var d=b(this.options[this.selectedIndex]).val();var e=parseInt(d);if(isNaN(e)){if(d!="none"){a.xhr.send({data:{method:d}})}}else{a.xhr.send({data:{method:"getByCategory",id:e}})}})};f.prototype.performDefault=function(){var a=this;switch(this.config["default"]){case"category":this.categories.trigger("change");break;case"shop":this.onSelect({data:{shop:{id:this.config.shopid}}});break}};f.prototype.onSelect=function(a){this.xhr.send({data:{method:"getByShop",id:a.data.shop.id}})};f.prototype.buildHref=function(a){var b={a_aid:this.config.partnerid,a_bid:"d968b18c",desturl:a,chan:this.config.channelid};var c,d="http://partner.gutscheinaffe.de/scripts/click.php?";for(var e in b){c=b[e];if(c){d+=encodeURIComponent(e)+"="+encodeURIComponent(c)+"&"}}d=d.substr(0,d.length-"&".length);return d};b(function(){b(".gutscheinaffe_widget").each(function(a,b){new f(b)})})})(window,jQuery)